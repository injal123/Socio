// Prisma schema - Socio App
// Learn more in docs: https://pris.ly/d/prisma-schema


// “Generate JavaScript code so my app can talk to the database”
generator client {
  provider = "prisma-client-js"           // add -js
}

// “My database is Postgres, and its address is stored in .env”
datasource db {
  provider = "postgresql"
}






// cuid = collision-resistant unique id.

model User {
  id    String   @id @default(cuid())  // Prisma auto-generates a unique string, like ckz9xk3zv0001abc123.
  clerkId   String   @unique
  username  String   @unique
  email     String   @unique

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  image     String?  // '?' means optional.
  name      String?
  bio       String?
  location  String?
  website   String?

  // Relations --------> [] means many, & No [] means one... (User's action).
  posts     Post[]       // "One user can create many posts."
  likes     Like[]       // "One user can like many posts."
  comments  Comment[]    // "One user can write many comments."

  followers Follows[] @relation("UsersWhoFollowMe")  // "Many users can follow this user."
  following Follows[] @relation("UsersIFollow")   // "This user follows many other users."

  notificationsReceived Notification[] @relation("UserNotificationsReceived")   // "Notifications received by this user."
  notificationsSent Notification[] @relation("UserNotificationsSent")  // "Notifications created by this user."
}







model Post {
  id          String     @id @default(cuid())
  authorId    String     // post created by which user.
  content     String?    // ? -> optional, means a post can either have content or
  image       String?    // or image, or both or none(no post).

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  // Relations
  author      User       @relation(fields: [authorId], references: [id], onDelete: Cascade) // cascade delete means, if author is deleted then delete all his posts.
  likes           Like[]
  comments        Comment[]
  notifications   Notification[]
}







model Comment {
  id          String    @id @default(cuid())
  authorId    String   // who commented..?
  postId      String   // comment on which post..?
  content     String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Reply system
  parentId      String?
  parentComment Comment?  @relation("CommentReplies", fields: [parentId], references: [id])
  childComments Comment[] @relation("CommentReplies")

  // Relations
  author          User            @relation(fields: [authorId], references: [id], onDelete: Cascade)
  post            Post            @relation(fields: [postId], references: [id], onDelete: Cascade)
  notifications   Notification[]

  @@index([authorId, postId]) // composite index for faster queries - to search for a comments written by authorId in postId.
}







model Like {
  id          String    @id @default(cuid())
  userId      String    // owner of this like.
  postId      String
  createdAt   DateTime  @default(now())

  // Relations
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  post        Post      @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([userId, postId])   // gimme the likes done by userId in this post postId.
  @@unique([userId, postId])  // prevents same user liking post twice.
} 







model Follows {
  followerId      String
  followingId     String
  createdAt       DateTime  @default(now())

  // Relations
  follower    User   @relation("UsersIFollow", fields: [followerId], references: [id], onDelete: Cascade)
  following   User   @relation("UsersWhoFollowMe", fields: [followingId], references: [id], onDelete: Cascade)

  @@index([followerId, followingId])    // composite index for faster query.
  @@id([followerId, followingId])       // coposite primary key to prevent duplicate follows.
}







model Notification {
  id          String      @id @default(cuid())
  userId      String   // notification receiver.
  creatorId   String   // notification creator.
  createdAt   DateTime    @default(now())

  type        NotificationType
  read        Boolean     @default(false)
  postId      String?   // follow-notification isn't related to post ... so its optional.
  commentId   String?

  // Relations:
  user     User  @relation("UserNotificationsReceived", fields: [userId], references: [id], onDelete: Cascade)     
  creator  User  @relation("UserNotificationsSent", fields: [creatorId], references: [id], onDelete: Cascade)

  post      Post?     @relation(fields: [postId], references: [id], onDelete: Cascade)
  comment   Comment?  @relation(fields: [commentId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
}




enum NotificationType {
  LIKE
  COMMENT
  FOLLOW
}



// at the end:   npx prisma db push